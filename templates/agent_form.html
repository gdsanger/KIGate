{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        {% if mode == "create" %}
            Neuen Agent erstellen
        {% else %}
            Agent bearbeiten: {{ agent.name }}
        {% endif %}
    </h1>
    <div>
        <a href="/admin/agents" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Zurück zur Übersicht
        </a>
    </div>
</div>

{% if message %}
<div class="alert alert-{{ message_type }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    {% if mode == "create" %}
                        Agent Informationen
                    {% else %}
                        Agent bearbeiten
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{% if mode == 'create' %}/admin/agents/create{% else %}/admin/agents/{{ agent.name }}/update{% endif %}">
                    <div class="mb-3">
                        <label for="name" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="name" name="name" 
                               value="{% if agent %}{{ agent.name }}{% endif %}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Beschreibung *</label>
                        <textarea class="form-control" id="description" name="description" rows="3" required>{% if agent %}{{ agent.description }}{% endif %}</textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="role" class="form-label">Rolle *</label>
                                <textarea class="form-control" id="role" name="role" rows="3" required>{% if agent %}{{ agent.role }}{% endif %}</textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="provider" class="form-label">Provider *</label>
                                <select class="form-select" id="provider" name="provider" required onchange="loadModelsForProvider()">
                                    <option value="">Bitte wählen...</option>
                                    {% if providers %}
                                        {% for provider in providers %}
                                            <option value="{{ provider.name }}" {% if agent and agent.provider == provider.name %}selected{% endif %}>
                                                {{ provider.name }} ({{ provider.provider_type }})
                                            </option>
                                        {% endfor %}
                                    {% else %}
                                        <option value="openai" {% if agent and agent.provider == "openai" %}selected{% endif %}>openai</option>
                                        <option value="gemini" {% if agent and agent.provider == "gemini" %}selected{% endif %}>gemini</option>
                                        <option value="claude" {% if agent and agent.provider == "claude" %}selected{% endif %}>claude</option>
                                        <option value="ollama" {% if agent and agent.provider == "ollama" %}selected{% endif %}>ollama</option>
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="model" class="form-label">Modell *</label>
                                <select class="form-select" id="model" name="model" required>
                                    <option value="">Zuerst Provider wählen...</option>
                                    {% if agent %}
                                        <option value="{{ agent.model }}" selected>{{ agent.model }}</option>
                                    {% endif %}
                                </select>
                                <div class="form-text" id="model-hint">Wählen Sie einen Provider, um verfügbare Modelle zu laden</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="task" class="form-label">Aufgabe *</label>
                        <textarea class="form-control" id="task" name="task" rows="6" required 
                                  placeholder="Detaillierte Beschreibung der Aufgabe des Agenten...">{% if agent %}{{ agent.task }}{% endif %}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="parameters" class="form-label">Parameter (YAML)</label>
                        <textarea class="form-control" id="parameters" name="parameters" rows="8" 
                                  placeholder="- Inputtext:&#10;    type: string&#10;    description: The input text.&#10;- Model:&#10;    type: string&#10;    description: The model to use.&#10;    default: gpt-4"></textarea>
                        <div class="form-text">Optional: Parameter im YAML-Format definieren</div>
                    </div>
                    
                    <div class="d-flex justify-content-end gap-2">
                        <a href="/admin/agents" class="btn btn-secondary">Abbrechen</a>
                        <button type="submit" class="btn btn-primary">
                            {% if mode == "create" %}
                                Erstellen
                            {% else %}
                                Speichern
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    {% if agent %}
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Vorschau</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Provider:</strong>
                    <span class="badge bg-primary">{{ agent.provider }}</span>
                </div>
                <div class="mb-3">
                    <strong>Modell:</strong>
                    <span class="badge bg-info">{{ agent.model }}</span>
                </div>
                {% if agent.parameters %}
                <div class="mb-3">
                    <strong>Parameter:</strong>
                    <div class="small mt-2">
                        {% for param_dict in agent.parameters %}
                            {% for param_name, param_info in param_dict.items() %}
                            <div class="mb-2 p-2 border rounded">
                                <strong>{{ param_name }}</strong>
                                <div class="text-muted small">{{ param_info.type }}</div>
                            </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Store providers data
let providersData = [];

// Load providers on page load
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await fetch('/admin/api/providers-for-agents');
        if (response.ok) {
            providersData = await response.json();
            
            // If editing an agent, load models for current provider
            {% if agent and agent.provider %}
            await loadModelsForProvider();
            {% endif %}
        }
    } catch (error) {
        console.error('Error loading providers:', error);
    }
    
    // Auto-populate parameter YAML for editing
    {% if agent and agent.parameters %}
    const agentData = {
        name: "{{ agent.name }}",
        description: "{{ agent.description }}",
        role: "{{ agent.role }}",
        provider: "{{ agent.provider }}",
        model: "{{ agent.model }}",
        task: "{{ agent.task }}",
        parameters: {{ agent.parameters | tojson if agent.parameters else '[]' }}
    };
    
    let parametersYaml = '';
    if (agentData.parameters && Array.isArray(agentData.parameters)) {
        parametersYaml = agentData.parameters.map(param => {
            const entries = Object.entries(param);
            return entries.map(([key, value]) => {
                let yaml = `- ${key}:\n`;
                if (value.type) yaml += `    type: ${value.type}\n`;
                if (value.description) yaml += `    description: ${value.description}\n`;
                if (value.default) yaml += `    default: ${value.default}\n`;
                return yaml;
            }).join('');
        }).join('');
    }
    document.getElementById('parameters').value = parametersYaml;
    {% endif %}
});

async function loadModelsForProvider() {
    const providerSelect = document.getElementById('provider');
    const modelSelect = document.getElementById('model');
    const modelHint = document.getElementById('model-hint');
    
    const providerName = providerSelect.value;
    
    if (!providerName) {
        modelSelect.innerHTML = '<option value="">Zuerst Provider wählen...</option>';
        modelHint.textContent = 'Wählen Sie einen Provider, um verfügbare Modelle zu laden';
        return;
    }
    
    // Find provider by name
    const provider = providersData.find(p => p.name === providerName);
    
    if (!provider) {
        modelSelect.innerHTML = '<option value="">Provider nicht gefunden</option>';
        modelHint.textContent = 'Provider wurde nicht gefunden';
        return;
    }
    
    try {
        modelHint.textContent = 'Lade Modelle...';
        const response = await fetch(`/admin/api/providers/${provider.id}/models`);
        
        if (!response.ok) {
            throw new Error('Failed to load models');
        }
        
        const models = await response.json();
        
        {% if agent %}
        const currentModel = "{{ agent.model }}";
        {% else %}
        const currentModel = null;
        {% endif %}
        
        if (models.length === 0) {
            modelSelect.innerHTML = '<option value="">Keine aktiven Modelle verfügbar</option>';
            modelHint.textContent = 'Bitte laden Sie Modelle vom Provider in der Provider-Verwaltung';
        } else {
            modelSelect.innerHTML = '<option value="">Bitte wählen...</option>';
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name;
                if (currentModel && model.id === currentModel) {
                    option.selected = true;
                }
                modelSelect.appendChild(option);
            });
            modelHint.textContent = `${models.length} Modell(e) verfügbar`;
        }
    } catch (error) {
        console.error('Error loading models:', error);
        modelSelect.innerHTML = '<option value="">Fehler beim Laden der Modelle</option>';
        modelHint.textContent = 'Fehler beim Laden der Modelle';
    }
}
</script>
{% endblock %}