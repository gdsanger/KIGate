{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Repository Management</h1>
</div>

<!-- Display messages -->
{% if message %}
    <div class="alert alert-{{ message_type if message_type else 'info' }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
{% endif %}

<!-- Sync Repositories Form -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Repositories von GitHub synchronisieren</h5>
            </div>
            <div class="card-body">
                <form action="/admin/repositories/sync" method="post">
                    <div class="mb-3">
                        <label for="username_or_org" class="form-label">GitHub Username oder Organization</label>
                        <input type="text" class="form-control" id="username_or_org" name="username_or_org" 
                               placeholder="z.B. eoe-university oder username" required>
                        <div class="form-text">Geben Sie den GitHub Username oder Organization Namen ein, um alle Repositories zu laden.</div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-cloud-download"></i> Repositories synchronisieren
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Help Information -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Hilfe</h6>
            </div>
            <div class="card-body">
                <h6>Repository Synchronisation</h6>
                <p class="small">Diese Funktion lädt alle Repositories eines GitHub Users oder einer Organization in die lokale Datenbank.</p>
                
                <h6>Aktive Repositories</h6>
                <p class="small">Nur aktive Repositories werden in der Dropdown-Liste für GitHub Issues angezeigt.</p>
                
                <h6>Beispiele</h6>
                <ul class="small">
                    <li><code>eoe-university</code> - Organization</li>
                    <li><code>github</code> - Username</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Repositories Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Repositories</h5>
                <span class="badge bg-secondary">{{ repositories|length }} Repositories</span>
            </div>
            <div class="card-body">
                {% if repositories %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Repository</th>
                                    <th>Beschreibung</th>
                                    <th>Typ</th>
                                    <th>Status</th>
                                    <th>Letzte Aktualisierung</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for repo in repositories %}
                                <tr id="repo-row-{{ repo.id }}">
                                    <td>
                                        <a href="{{ repo.html_url }}" target="_blank" class="text-decoration-none">
                                            <code>{{ repo.full_name }}</code>
                                            <i class="bi bi-box-arrow-up-right"></i>
                                        </a>
                                    </td>
                                    <td>
                                        {% if repo.description %}
                                            {{ repo.description[:100] }}{% if repo.description|length > 100 %}...{% endif %}
                                        {% else %}
                                            <span class="text-muted">Keine Beschreibung</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if repo.is_private %}
                                            <span class="badge bg-warning">Private</span>
                                        {% else %}
                                            <span class="badge bg-success">Public</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="switch-{{ repo.id }}" 
                                                   {% if repo.is_active %}checked{% endif %}
                                                   onchange="toggleRepoStatus({{ repo.id }})">
                                            <label class="form-check-label" for="switch-{{ repo.id }}">
                                                <span id="status-text-{{ repo.id }}">
                                                    {% if repo.is_active %}Aktiv{% else %}Inaktiv{% endif %}
                                                </span>
                                            </label>
                                        </div>
                                    </td>
                                    <td>{{ repo.last_updated.strftime('%d.%m.%Y %H:%M') if repo.last_updated else '-' }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="deleteRepo({{ repo.id }}, '{{ repo.full_name }}')"
                                                title="Repository löschen">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <h5 class="text-muted">Keine Repositories gefunden</h5>
                        <p class="text-muted">Synchronisieren Sie Repositories von GitHub mit dem Formular oben.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteRepoModal" tabindex="-1" aria-labelledby="deleteRepoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteRepoModalLabel">Repository löschen</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Sind Sie sicher, dass Sie das Repository <strong id="deleteRepoName"></strong> löschen möchten?
                <br><br>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    Diese Aktion kann nicht rückgängig gemacht werden.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteRepo">Löschen</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let repoToDelete = null;

function toggleRepoStatus(repoId) {
    fetch(`/admin/repositories/${repoId}/toggle-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.is_active !== undefined) {
            // Update status text
            const statusText = document.getElementById(`status-text-${repoId}`);
            statusText.textContent = data.is_active ? 'Aktiv' : 'Inaktiv';
        } else if (data.detail) {
            alert('Fehler: ' + data.detail);
            // Revert switch state
            const switchElement = document.getElementById(`switch-${repoId}`);
            switchElement.checked = !switchElement.checked;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Fehler beim Aktualisieren des Repository-Status');
        // Revert switch state
        const switchElement = document.getElementById(`switch-${repoId}`);
        switchElement.checked = !switchElement.checked;
    });
}

function deleteRepo(repoId, repoName) {
    repoToDelete = repoId;
    document.getElementById('deleteRepoName').textContent = repoName;
    new bootstrap.Modal(document.getElementById('deleteRepoModal')).show();
}

document.getElementById('confirmDeleteRepo').addEventListener('click', function() {
    if (repoToDelete) {
        fetch(`/admin/repositories/${repoToDelete}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                // Remove row from table
                const row = document.getElementById(`repo-row-${repoToDelete}`);
                if (row) {
                    row.remove();
                }
                // Hide modal
                bootstrap.Modal.getInstance(document.getElementById('deleteRepoModal')).hide();
                // Show success message
                showAlert('Repository wurde erfolgreich gelöscht', 'success');
            } else if (data.detail) {
                alert('Fehler: ' + data.detail);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Fehler beim Löschen des Repositories');
        })
        .finally(() => {
            repoToDelete = null;
        });
    }
});

function showAlert(message, type) {
    const alertsContainer = document.querySelector('.container-fluid');
    const alertElement = document.createElement('div');
    alertElement.className = `alert alert-${type} alert-dismissible fade show`;
    alertElement.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // Insert after the header
    const header = alertsContainer.querySelector('.border-bottom');
    if (header && header.nextSibling) {
        alertsContainer.insertBefore(alertElement, header.nextSibling);
    } else {
        alertsContainer.appendChild(alertElement);
    }
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        if (alertElement.classList.contains('show')) {
            const bsAlert = new bootstrap.Alert(alertElement);
            bsAlert.close();
        }
    }, 5000);
}

// Auto-hide alerts after 5 seconds
document.addEventListener('DOMContentLoaded', function() {
    const alerts = document.querySelectorAll('.alert-dismissible');
    alerts.forEach(function(alert) {
        setTimeout(function() {
            if (alert.classList.contains('show')) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 5000);
    });
});
</script>
{% endblock %}